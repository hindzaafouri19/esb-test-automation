name: Orchestrator Backend Update

on:
  repository_dispatch:
    types: [microservice-updated]

jobs:
  update-backend-image:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout orchestrator repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2️⃣ Set backend image metadata
      - name: Set backend image metadata
        run: |
          BACKEND_IMAGE="${{ github.event.client_payload.image }}"
          IMAGE_NAME="${BACKEND_IMAGE%:*}"   # everything before last colon
          IMAGE_TAG="${BACKEND_IMAGE##*:}"   # everything after last colon
          echo "BACKEND_IMAGE=$BACKEND_IMAGE" >> $GITHUB_ENV
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      # 3️⃣ Display debug info
      - name: Show backend image info
        run: |
          echo "Full image: $BACKEND_IMAGE"
          echo "Image name: $IMAGE_NAME"
          echo "Image tag: $IMAGE_TAG"

      # 4️⃣ Override backend image in docker-compose.test.yml
      - name: Override backend image in Compose file
        run: |
          COMPOSE_FILE=docker-compose.test.yml
          # Backup original file
          cp $COMPOSE_FILE $COMPOSE_FILE.bak
          # Replace image line
          sed -i "s|image: $IMAGE_NAME:latest|image: $BACKEND_IMAGE|g" $COMPOSE_FILE

      # 5️⃣ Display the updated Compose file
      - name: Display overridden docker-compose.test.yml
        run: |
          echo "===== Updated docker-compose.test.yml ====="
          cat docker-compose.test.yml
          echo "=========================================="
